generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum BookingKind {
  DIAGNOSTICS
}

enum BookingStatus {
  NEW
  PENDING_PAYMENT
  CONFIRMED
  CANCELLED
  EXPIRED
  IN_PROGRESS
  COMPLETED
}

enum QuoteCategory {
  BRAKES
  WOF_REPAIRS
  SERVICING
  OTHER
}

enum QuoteUrgency {
  TODAY
  THIS_WEEK
  FLEXIBLE
}

enum RequestStatus {
  NEW
  CONTACTED
  BOOKED
  IN_PROGRESS
  COMPLETED
  CLOSED
}

enum JobStatus {
  NEW
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  CLOSED
}

enum MediaOwnerType {
  BOOKING
  QUOTE_REQUEST
  REPORT
}

enum IntegrationProvider {
  SERVICEM8
}

enum ServiceReportType {
  DIAGNOSTICS
  PPI
}

enum ServiceReportStatus {
  DRAFT
  FINAL
}

enum AuditActorType {
  ADMIN
  SYSTEM
}

model Customer {
  id          String   @id @default(uuid())
  publicId    String   @unique
  fullName    String
  email       String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  vehicles    Vehicle[]
  addresses   Address[]
  bookings    Booking[]
  quoteRequests QuoteRequest[]
  jobs        Job[]

  serviceM8ClientId String? @unique

  @@index([email])
  @@index([phone])
}

model Vehicle {
  id          String   @id @default(uuid())
  publicId    String   @unique
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  plate       String?
  vin         String?
  make        String?
  model       String?
  year        Int?
  fuel        String?
  odometer    String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  bookings    Booking[]
  quoteRequests QuoteRequest[]
  jobs        Job[]

  @@index([plate])
  @@index([vin])
}

model Address {
  id          String   @id @default(uuid())
  publicId    String   @unique
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])

  line1       String
  suburb      String
  city        String
  postcode    String?
  lat         Float?
  lng         Float?
  travelBand  String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  bookings    Booking[]
  quoteRequests QuoteRequest[]
  jobs        Job[]

  @@index([suburb])
}

model Booking {
  id                 String        @id @default(uuid())
  publicId            String        @unique
  kind               BookingKind
  status             BookingStatus

  customerId         String
  customer           Customer      @relation(fields: [customerId], references: [id])
  vehicleId          String?
  vehicle            Vehicle?      @relation(fields: [vehicleId], references: [id])
  addressId          String
  address            Address       @relation(fields: [addressId], references: [id])

  slotStart          DateTime
  slotEnd            DateTime
  afterHours         Boolean       @default(false)

  symptomPreset      String?
  notes              String?

  pricingSnapshotJson Json

  stripeSessionId    String?
  paymentExpiresAt   DateTime?

  serviceM8JobId     String? @unique
  serviceM8Url       String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  media              Media[]
  reports            ServiceReport[]
  job                Job?

  holdExpiresAt      DateTime?
  idempotencyKey     String?   @unique

  @@index([status])
  @@index([slotStart])
  @@index([customerId])
}

model VehicleCache {
  plate               String   @id
  identityJson        Json
  classificationJson  Json
  createdAt           DateTime @default(now())
  expiresAt           DateTime
  lastAccessAt        DateTime @default(now())
  lookupCount         Int      @default(0)

  @@index([expiresAt])
}

model LookupLog {
  id          String   @id @default(uuid())
  plateHash   String
  ip          String
  fingerprint String?
  email       String?
  source      String
  status      String
  createdAt   DateTime @default(now())

  @@index([ip, createdAt])
  @@index([fingerprint, createdAt])
  @@index([plateHash])
}

model ServiceReport {
  id          String            @id @default(uuid())
  bookingId   String
  booking     Booking           @relation(fields: [bookingId], references: [id])

  type        ServiceReportType
  status      ServiceReportStatus @default(DRAFT)

  /**
   * JSON payload for the report (markdown content, structured fields, attachment list, etc.)
   */
  dataJson    Json

  /**
   * Public token used for customer-facing link: /report/[token]
   */
  publicToken String            @unique

  emailedAt   DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([bookingId])
}

model QuoteRequest {
  id                  String        @id @default(uuid())
  publicId             String        @unique
  status              RequestStatus
  category            QuoteCategory
  urgency             QuoteUrgency

  customerId          String
  customer            Customer      @relation(fields: [customerId], references: [id])
  vehicleId           String?
  vehicle             Vehicle?      @relation(fields: [vehicleId], references: [id])
  addressId           String
  address             Address       @relation(fields: [addressId], references: [id])

  symptoms            Json
  description         String?

  pricingSnapshotJson Json

  serviceM8JobId      String? @unique
  serviceM8Url        String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  media               Media[]

  job                 Job?

  @@index([status])
  @@index([category])
  @@index([customerId])
}

model Job {
  id            String     @id @default(uuid())
  publicId      String     @unique
  status        JobStatus  @default(NEW)

  title         String
  description   String?
  internalNotes String?

  customerId    String
  customer      Customer   @relation(fields: [customerId], references: [id])
  vehicleId     String?
  vehicle       Vehicle?   @relation(fields: [vehicleId], references: [id])
  addressId     String
  address       Address    @relation(fields: [addressId], references: [id])

  quoteRequestId String?    @unique
  quoteRequest   QuoteRequest? @relation(fields: [quoteRequestId], references: [id])

  bookingId     String?    @unique
  booking       Booking?   @relation(fields: [bookingId], references: [id])

  scheduledStart DateTime?
  scheduledEnd   DateTime?

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([status])
  @@index([scheduledStart])
  @@index([customerId])
}

model Media {
  id           String        @id @default(uuid())
  publicId     String        @unique
  ownerType    MediaOwnerType
  bookingId    String?
  booking      Booking?      @relation(fields: [bookingId], references: [id])
  quoteRequestId String?
  quoteRequest QuoteRequest? @relation(fields: [quoteRequestId], references: [id])

  contentType  String
  sizeBytes    Int
  r2Key        String
  sha256       String?

  createdAt    DateTime @default(now())

  @@index([ownerType])
}

model AvailabilityBlock {
  id          String   @id @default(uuid())
  start       DateTime
  end         DateTime
  reason      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([start])
  @@index([end])
}

model AdminUser {
  id           String   @id @default(uuid())
  email        String   @unique
  name         String?
  role         String   @default("ADMIN")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model AuditLog {
  id           String        @id @default(uuid())
  actorType    AuditActorType
  actorId      String?
  action       String
  entityType   String
  entityId     String
  beforeJson   Json?
  afterJson    Json?
  ip           String?
  userAgent    String?
  createdAt    DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model IntegrationToken {
  id             String               @id @default(uuid())
  provider       IntegrationProvider
  label          String               @default("default")

  // Encrypted at rest (application-layer). Store base64 ciphertext, iv, and auth tag.
  accessTokenEnc String
  refreshTokenEnc String?
  iv             String
  authTag        String

  expiresAt      DateTime?
  scopes         String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([provider, label])
}

model IdempotencyKey {
  id          String   @id @default(uuid())
  scope       String
  key         String
  requestHash String?
  responseJson Json?
  createdAt   DateTime @default(now())

  @@unique([scope, key])
}

model InstantQuote {
  id                  String   @id @default(uuid())
  publicId            String   @unique
  status              String   @default("NEW")
  pricingSnapshotJson Json
  vehicleId           String?
  customerId          String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model TechnicianSchedule {
  id          String   @id @default(uuid())
  date        DateTime @unique
  startTime   String
  endTime     String
  maxBookings Int      @default(4)
  bookedSlots Json?    // Array of slots or similar
  primaryZone String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GeographicZone {
  id            String   @id @default(uuid())
  name          String   @unique
  suburbs       String[]
  preferredDays String[]
  isActive      Boolean  @default(true)
}
