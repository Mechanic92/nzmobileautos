"use strict";exports.id=2944,exports.ids=[2944],exports.modules={22944:(e,t,a)=>{a.d(t,{BG:()=>u,Fz:()=>l,XU:()=>o,db:()=>w,x4:()=>c});var r=a(55511),s=a.n(r);function n(e){let t=s().randomBytes(8).toString("base64url");return`${e}_${t}`}function i(){return!!process.env.DATABASE_URL}class o extends Error{constructor(e){super(e),this.code="DB_UNAVAILABLE",this.name="DbUnavailableError"}}async function d(e){let t;let a=[0,120,300];for(let r=0;r<a.length;r++){a[r]>0&&await function(e){return new Promise(t=>setTimeout(t,e))}(a[r]);try{return await e()}catch(e){if(t=e,!function(e){let t=String(e?.message||""),a=String(e?.code||"");return"P1001"===a||"P1002"===a||t.toLowerCase().includes("can't reach database server")||t.toLowerCase().includes("cant reach database server")||t.toLowerCase().includes("econnrefused")||t.toLowerCase().includes("etimedout")||t.toLowerCase().includes("enotfound")||t.toLowerCase().includes("connection terminated")}(e)||r===a.length-1)throw e}}throw t}async function l(){if(c())return{ok:!0,latencyMs:0};if(!i())return{ok:!1,latencyMs:0,error:"Missing DATABASE_URL"};let e=Date.now();try{let{prisma:t}=await a.e(3374).then(a.bind(a,93374)),r=Number(process.env.DB_HEALTHCHECK_TIMEOUT_MS||"1200")||1200;return await d(async()=>{await Promise.race([t.$queryRaw`SELECT 1`,new Promise((e,t)=>setTimeout(()=>t(Error("DB healthcheck timeout")),r))])}),{ok:!0,latencyMs:Date.now()-e}}catch(a){let t=String(a?.message||"DB healthcheck failed");return{ok:!1,latencyMs:Date.now()-e,error:t}}}async function u(){let e=await l();if(!e.ok)throw new o(e.error||"Database is currently unavailable");return e}function c(){return"true"===process.env.DEV_NO_DB||!i()}let p=global.__devNoDbStore||(global.__devNoDbStore={bookings:new Map,quoteRequests:new Map,jobs:new Map,serviceReports:new Map,idempotency:new Map});function y(){return s().randomBytes(24).toString("base64url")}let m={async createDiagnosticsBooking(e){let t=s().randomUUID(),a=new Date,r={id:t,publicId:n("bk"),kind:"DIAGNOSTICS",status:"PENDING_PAYMENT",customerId:n("cust"),addressId:n("addr"),vehicleId:n("veh"),slotStart:e.slotStart,slotEnd:e.slotEnd,afterHours:e.afterHours,symptomPreset:e.symptomPreset??null,notes:e.notes??null,pricingSnapshotJson:e.pricingSnapshotJson,stripeSessionId:null,paymentExpiresAt:e.paymentExpiresAt,serviceM8JobId:null,serviceM8Url:null,createdAt:a,updatedAt:a};return p.bookings.set(t,r),r},async createJob(e){let t=s().randomUUID(),a=new Date,r={id:t,publicId:n("job"),status:e.status??"NEW",title:e.title,description:e.description??null,internalNotes:e.internalNotes??null,customerId:n("cust"),addressId:n("addr"),vehicleId:e.vehicle?n("veh"):null,quoteRequestId:null,bookingId:null,scheduledStart:null,scheduledEnd:null,createdAt:a,updatedAt:a};return p.jobs.set(t,r),r},listJobs:async e=>Array.from(p.jobs.values()).sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()).slice(0,e),async updateJobStatus(e,t){let a=p.jobs.get(e.id);if(!a)throw Error("Job not found");let r={...a,status:t.status,updatedAt:new Date};return p.jobs.set(e.id,r),r},getJobById:async e=>p.jobs.get(e)??null,async createQuoteRequest(e){let t=s().randomUUID(),a=new Date,r={id:t,publicId:n("qr"),status:"NEW",category:e.category,urgency:e.urgency,customerId:n("cust"),addressId:n("addr"),vehicleId:n("veh"),symptoms:e.symptoms,description:e.description,pricingSnapshotJson:e.pricingSnapshotJson,serviceM8JobId:null,serviceM8Url:null,createdAt:a,updatedAt:a};return p.quoteRequests.set(t,r),r},async updateQuoteRequestStatus(e,t){let a=p.quoteRequests.get(e.id);if(!a)throw Error("Quote request not found");let r={...a,status:t.status,updatedAt:new Date};return p.quoteRequests.set(e.id,r),r},listQuoteRequests:async e=>Array.from(p.quoteRequests.values()).sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()).slice(0,e),async updateBookingStatus(e,t){let a=p.bookings.get(e.id);if(!a)throw Error("Booking not found");let r={...a,status:t.status,updatedAt:new Date};return p.bookings.set(e.id,r),r},async updateBookingStripeSession(e,t){let a=p.bookings.get(e.id);if(!a)throw Error("Booking not found");let r={...a,stripeSessionId:t.stripeSessionId,updatedAt:new Date};return p.bookings.set(e.id,r),r},getBookingById:async e=>p.bookings.get(e)??null,listBookings:async e=>Array.from(p.bookings.values()).sort((e,t)=>t.createdAt.getTime()-e.createdAt.getTime()).slice(0,e),async expirePendingBookings(e){let t=0;for(let a of p.bookings.values())"PENDING_PAYMENT"===a.status&&a.paymentExpiresAt&&a.paymentExpiresAt.getTime()<=e.getTime()&&(p.bookings.set(a.id,{...a,status:"EXPIRED",updatedAt:new Date}),t++);return t},async createIdempotencyKeyOnce(e){var t,a;let r=(t=e.scope,a=e.key,`${t}:${a}`);return p.idempotency.has(r)?{created:!1}:(p.idempotency.set(r,{scope:e.scope,key:e.key,createdAt:new Date}),{created:!0})},async createOrGetServiceReportForBooking(e){let t=Array.from(p.serviceReports.values()).find(t=>t.bookingId===e.bookingId&&t.type===e.type);if(t)return t;let a=s().randomUUID(),r=new Date,n={id:a,bookingId:e.bookingId,type:e.type,status:"DRAFT",dataJson:{version:1,type:e.type,title:"DIAGNOSTICS"===e.type?"Diagnostics Report":"Pre-Purchase Inspection Report",summary:"",contentMarkdown:"",attachments:[]},publicToken:y(),emailedAt:null,createdAt:r,updatedAt:r};return p.serviceReports.set(a,n),n},async updateServiceReportData(e,t){let a=p.serviceReports.get(e.id);if(!a)throw Error("Service report not found");let r={...a,status:t.status??a.status,dataJson:t.dataJson,updatedAt:new Date};return p.serviceReports.set(e.id,r),r},async markServiceReportEmailed(e,t){let a=p.serviceReports.get(e.id);if(!a)throw Error("Service report not found");let r={...a,emailedAt:t.emailedAt,updatedAt:new Date};return p.serviceReports.set(e.id,r),r},getServiceReportByPublicToken:async e=>Array.from(p.serviceReports.values()).find(t=>t.publicToken===e)??null},b={async createDiagnosticsBooking(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.$transaction(async t=>{let a=(e.customer.email??"").trim().toLowerCase()||null,r=(e.customer.phone??"").trim()||null,s=await t.customer.findFirst({where:{OR:[...a?[{email:a}]:[],...r?[{phone:r}]:[]]}})??await t.customer.create({data:{publicId:n("cust"),fullName:e.customer.fullName,email:a,phone:r}}),i=await t.address.create({data:{publicId:n("addr"),customerId:s.id,line1:e.address.line1,suburb:e.address.suburb,city:e.address.city,postcode:e.address.postcode??null,lat:e.address.lat??null,lng:e.address.lng??null,travelBand:e.address.travelBand??null}}),o=await t.vehicle.create({data:{publicId:n("veh"),customerId:s.id,plate:e.vehicle.plate??null,make:e.vehicle.make??null,model:e.vehicle.model??null,year:e.vehicle.year??null,fuel:e.vehicle.fuel??null,odometer:e.vehicle.odometer??null}});return t.booking.create({data:{publicId:n("bk"),kind:"DIAGNOSTICS",status:"PENDING_PAYMENT",customerId:s.id,addressId:i.id,vehicleId:o.id,slotStart:e.slotStart,slotEnd:e.slotEnd,afterHours:e.afterHours,symptomPreset:e.symptomPreset??null,notes:e.notes??null,pricingSnapshotJson:e.pricingSnapshotJson,paymentExpiresAt:e.paymentExpiresAt}})})},async createQuoteRequest(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.$transaction(async t=>{let a=(e.customer.email??"").trim().toLowerCase()||null,r=(e.customer.phone??"").trim()||null,s=await t.customer.findFirst({where:{OR:[...a?[{email:a}]:[],...r?[{phone:r}]:[]]}})??await t.customer.create({data:{publicId:n("cust"),fullName:e.customer.fullName,email:a,phone:r}}),i=await t.address.create({data:{publicId:n("addr"),customerId:s.id,line1:e.address.line1,suburb:e.address.suburb,city:e.address.city,postcode:e.address.postcode??null,lat:e.address.lat??null,lng:e.address.lng??null,travelBand:e.address.travelBand??null}}),o=await t.vehicle.create({data:{publicId:n("veh"),customerId:s.id,plate:e.vehicle.plate??null,make:e.vehicle.make??null,model:e.vehicle.model??null,year:e.vehicle.year??null,fuel:e.vehicle.fuel??null,odometer:e.vehicle.odometer??null}});return t.quoteRequest.create({data:{publicId:n("qr"),status:"NEW",category:e.category,urgency:e.urgency,customerId:s.id,addressId:i.id,vehicleId:o.id,symptoms:e.symptoms,description:e.description,pricingSnapshotJson:e.pricingSnapshotJson}})})},async createJob(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.$transaction(async t=>{let a=(e.customer.email??"").trim().toLowerCase()||null,r=(e.customer.phone??"").trim()||null,s=await t.customer.findFirst({where:{OR:[...a?[{email:a}]:[],...r?[{phone:r}]:[]]}})??await t.customer.create({data:{publicId:n("cust"),fullName:e.customer.fullName,email:a,phone:r}}),i=await t.address.create({data:{publicId:n("addr"),customerId:s.id,line1:e.address.line1,suburb:e.address.suburb,city:e.address.city,postcode:e.address.postcode??null,lat:e.address.lat??null,lng:e.address.lng??null,travelBand:e.address.travelBand??null}}),o=e.vehicle?await t.vehicle.create({data:{publicId:n("veh"),customerId:s.id,plate:e.vehicle.plate??null,make:e.vehicle.make??null,model:e.vehicle.model??null,year:e.vehicle.year??null,fuel:e.vehicle.fuel??null,odometer:e.vehicle.odometer??null}}):null;return t.job.create({data:{publicId:n("job"),status:e.status??"NEW",title:e.title,description:e.description??null,internalNotes:e.internalNotes??null,customerId:s.id,addressId:i.id,vehicleId:o?.id??null}})})},async listJobs(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.job.findMany({orderBy:{createdAt:"desc"},take:e})},async updateJobStatus(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.job.update({where:{id:e.id},data:{status:t.status}})},async getJobById(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.job.findUnique({where:{id:e}})},async updateQuoteRequestStatus(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.quoteRequest.update({where:{id:e.id},data:{status:t.status}})},async listQuoteRequests(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.quoteRequest.findMany({orderBy:{createdAt:"desc"},take:e})},async updateBookingStatus(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.booking.update({where:{id:e.id},data:{status:t.status}})},async updateBookingStripeSession(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.booking.update({where:{id:e.id},data:{stripeSessionId:t.stripeSessionId}})},async getBookingById(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.booking.findUnique({where:{id:e}})},async listBookings(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.booking.findMany({orderBy:{createdAt:"desc"},take:e})},async expirePendingBookings(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return(await t.booking.updateMany({where:{status:"PENDING_PAYMENT",paymentExpiresAt:{lte:e}},data:{status:"EXPIRED"}})).count},async createIdempotencyKeyOnce(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));try{return await t.idempotencyKey.create({data:{scope:e.scope,key:e.key,requestHash:e.requestHash??null,responseJson:e.responseJson??null}}),{created:!0}}catch{return{created:!1}}},async createOrGetServiceReportForBooking(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374)),r=await t.serviceReport.findFirst({where:{bookingId:e.bookingId,type:e.type}});if(r)return r;let s={version:1,type:e.type,title:"DIAGNOSTICS"===e.type?"Diagnostics Report":"Pre-Purchase Inspection Report",summary:"",contentMarkdown:"",attachments:[]};return await t.serviceReport.create({data:{bookingId:e.bookingId,type:e.type,status:"DRAFT",dataJson:s,publicToken:y()}})},async updateServiceReportData(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.serviceReport.update({where:{id:e.id},data:{status:t.status,dataJson:t.dataJson}})},async markServiceReportEmailed(e,t){let{prisma:r}=await a.e(3374).then(a.bind(a,93374));return await r.serviceReport.update({where:{id:e.id},data:{emailedAt:t.emailedAt}})},async getServiceReportByPublicToken(e){let{prisma:t}=await a.e(3374).then(a.bind(a,93374));return await t.serviceReport.findUnique({where:{publicToken:e}})}};function w(){return c()?m:b}}};