(()=>{var e={};e.id=9596,e.ids=[3374,9596],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{"use strict";e.exports=require("child_process")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},28354:e=>{"use strict";e.exports=require("util")},34744:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>f,routeModule:()=>g,serverHooks:()=>v,workAsyncStorage:()=>x,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{POST:()=>h});var i=r(47268),a=r(61657),n=r(52624),o=r(88125),u=r(87109),p=r(93374),c=r(66506),d=r(35524);let l=new u.A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-01-27.acacia"}),m=d.Ik({quoteId:d.Yj().uuid(),startTime:d.Yj().datetime(),customer:d.Ik({name:d.Yj().min(1),email:d.Yj().email(),phone:d.Yj().min(10),line1:d.Yj().min(1),suburb:d.Yj().min(1)})});async function h(e){try{let t=await e.json(),r=m.safeParse(t);if(!r.success)return o.NextResponse.json({error:"Invalid input"},{status:400});let{quoteId:s,startTime:i,customer:a}=r.data,n=await p.prisma.quoteRequest.findUnique({where:{publicId:s},include:{vehicle:!0}});if(!n)return o.NextResponse.json({error:"Quote not found"},{status:404});let u=new Date(i),d=(0,c.z)(u,90);if(await p.prisma.booking.findFirst({where:{status:{in:["CONFIRMED","PENDING_PAYMENT"]},OR:[{AND:[{paymentExpiresAt:{gte:new Date}},{slotStart:{lt:d}},{slotEnd:{gt:u}}]},{AND:[{status:"CONFIRMED"},{slotStart:{lt:d}},{slotEnd:{gt:u}}]}]}}))return o.NextResponse.json({error:"This time slot was just taken. Please pick another."},{status:409});let h=await p.prisma.customer.findFirst({where:{email:a.email}});h=h?await p.prisma.customer.update({where:{id:h.id},data:{phone:a.phone,fullName:a.name}}):await p.prisma.customer.create({data:{publicId:crypto.randomUUID(),fullName:a.name,email:a.email,phone:a.phone}});let g=await p.prisma.address.create({data:{publicId:Math.random().toString(36).substring(7),customerId:h.id,line1:a.line1,suburb:a.suburb,city:"Auckland"}}),x=n.pricingSnapshotJson,w=(0,c.z)(new Date,15),v=await p.prisma.booking.create({data:{publicId:Math.random().toString(36).substring(7),kind:"DIAGNOSTICS",status:"PENDING_PAYMENT",customerId:h.id,vehicleId:n.vehicleId,addressId:g.id,slotStart:u,slotEnd:d,pricingSnapshotJson:x,paymentExpiresAt:w}}),f=e.headers.get("origin"),I=await l.checkout.sessions.create({payment_method_types:["card","afterpay_clearpay"],line_items:[{price_data:{currency:"nzd",product_data:{name:`Mobile Service: ${n.category}`,description:`For ${n.vehicle?.year} ${n.vehicle?.make} ${n.vehicle?.model}`},unit_amount:Math.round(100*x.total)},quantity:1}],mode:"payment",success_url:`${f}/booking/success?session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${f}/booking/cancel?id=${v.id}`,metadata:{bookingId:v.id},expires_at:Math.floor(w.getTime()/1e3)});return await p.prisma.booking.update({where:{id:v.id},data:{stripeSessionId:I.id}}),o.NextResponse.json({url:I.url})}catch(e){return console.error("[Stripe Session] Error:",e.message),o.NextResponse.json({error:"Internal Server Error"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/stripe/session/route",pathname:"/api/stripe/session",filename:"route",bundlePath:"app/api/stripe/session/route"},resolvedPagePath:"C:\\nzmobileautos\\next\\src\\app\\api\\stripe\\session\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:v}=g;function f(){return(0,n.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}},42167:()=>{},95311:()=>{},93374:(e,t,r)=>{"use strict";r.d(t,{prisma:()=>i});var s=r(96330);let i=global.__prisma||new s.PrismaClient},66506:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var s=r(57941),i=r(9739);function a(e,t,r){let a=(0,i.a)(e,r?.in);return a.setTime(a.getTime()+t*s.Cg),a}},57941:(e,t,r)=>{"use strict";r.d(t,{Cg:()=>i,_P:()=>o,_m:()=>n,my:()=>s,s0:()=>a});let s=6048e5,i=6e4,a=36e5,n=1e3,o=Symbol.for("constructDateFrom")},47649:(e,t,r)=>{"use strict";r.d(t,{w:()=>i});var s=r(57941);function i(e,t){return"function"==typeof e?e(t):e&&"object"==typeof e&&s._P in e?e[s._P](t):e instanceof Date?new e.constructor(t):new Date(t)}},9739:(e,t,r)=>{"use strict";r.d(t,{a:()=>i});var s=r(47649);function i(e,t){return(0,s.w)(t||e,e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4762,7560,5524,7109],()=>r(34744));module.exports=s})();