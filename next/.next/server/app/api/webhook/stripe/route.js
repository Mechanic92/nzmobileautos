(()=>{var e={};e.id=6375,e.ids=[3374,6375],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},79646:e=>{"use strict";e.exports=require("child_process")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},28354:e=>{"use strict";e.exports=require("util")},96880:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>h,serverHooks:()=>g,workAsyncStorage:()=>k,workUnitAsyncStorage:()=>b});var s={};t.r(s),t.d(s,{POST:()=>m});var o=t(47268),i=t(61657),a=t(52624),n=t(88125),c=t(87109),p=t(93374);async function u(e){let r=process.env.GEARBOX_API_URL||"https://api.gearbox.io/v1",t=process.env.GEARBOX_API_KEY;if(!t)return console.error("[Gearbox] API Key missing. Skipping ingestion."),{success:!1,error:"API_KEY_MISSING"};let s=`${r}/public/bookings/ingest`,o=async()=>{let r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({...e,source:"WEBSITE_CONVERSION_ENGINE",version:"1.0"})});if(!r.ok){let e=await r.text();throw Error(`Gearbox API Error: ${r.status} - ${e}`)}return await r.json()},i=0;for(;i<3;)try{let r=await o();return console.log(`[Gearbox] Ingestion successful for booking ${e.booking.id}`),{success:!0,jobId:r.id}}catch(e){if(i++,console.error(`[Gearbox] Attempt ${i} failed:`,e.message),i>=3)return{success:!1,error:e.message};await new Promise(e=>setTimeout(e,1e3*i))}return{success:!1,error:"MAX_RETRIES_EXCEEDED"}}let d=new c.A(process.env.STRIPE_SECRET_KEY,{apiVersion:"2025-01-27.acacia"}),l=process.env.STRIPE_WEBHOOK_SECRET;async function m(e){let r;let t=await e.text(),s=e.headers.get("stripe-signature");try{if(!s||!l)throw Error("Missing stripe-signature or webhook secret");r=d.webhooks.constructEvent(t,s,l)}catch(e){return console.error(`[Stripe Webhook] Error: ${e.message}`),n.NextResponse.json({error:`Webhook Error: ${e.message}`},{status:400})}if("checkout.session.completed"===r.type){let e=r.data.object;if(await p.prisma.idempotencyKey.findUnique({where:{scope_key:{scope:"stripe-webhook",key:r.id}}}))return n.NextResponse.json({received:!0,message:"Already processed"});let t=e.metadata?.bookingId;if(!t)return console.error("[Stripe Webhook] No bookingId in metadata"),n.NextResponse.json({error:"No bookingId in metadata"},{status:400});try{let s=await p.prisma.$transaction(async s=>{let o=await s.booking.update({where:{id:t},data:{status:"CONFIRMED"},include:{customer:!0,vehicle:!0,address:!0}});return await s.idempotencyKey.create({data:{scope:"stripe-webhook",key:r.id,requestHash:e.id}}),o});console.log(`[Stripe Webhook] Booking ${t} marked as CONFIRMED`);let o=s.pricingSnapshotJson,i=await u({customer:{name:s.customer.fullName,email:s.customer.email||"",phone:s.customer.phone||""},vehicle:{plate:s.vehicle?.plate||"",vin:s.vehicle?.vin||"",make:s.vehicle?.make||"",model:s.vehicle?.model||"",year:s.vehicle?.year||0,snapshot:s.vehicle||{}},booking:{id:s.id,startTime:s.slotStart,endTime:s.slotEnd,address:`${s.address.line1}, ${s.address.suburb}`,serviceType:s.kind,totalAmount:o?.total||0},payment:{stripeSessionId:e.id,amount:(e.amount_total||0)/100}});i.success?await p.prisma.booking.update({where:{id:t},data:{serviceM8JobId:i.jobId}}):console.error(`[Stripe Webhook] Gearbox ingestion failed for ${t}`)}catch(e){return console.error(`[Stripe Webhook] DB Error: ${e.message}`),n.NextResponse.json({error:"Internal Server Error"},{status:500})}}return n.NextResponse.json({received:!0})}let h=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/webhook/stripe/route",pathname:"/api/webhook/stripe",filename:"route",bundlePath:"app/api/webhook/stripe/route"},resolvedPagePath:"C:\\nzmobileautos\\next\\src\\app\\api\\webhook\\stripe\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:k,workUnitAsyncStorage:b,serverHooks:g}=h;function x(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:b})}},42167:()=>{},95311:()=>{},93374:(e,r,t)=>{"use strict";t.d(r,{prisma:()=>o});var s=t(96330);let o=global.__prisma||new s.PrismaClient}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4762,7560,7109],()=>t(96880));module.exports=s})();