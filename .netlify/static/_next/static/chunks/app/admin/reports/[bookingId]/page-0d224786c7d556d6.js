(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[225,333],{678:(e,t,a)=>{Promise.resolve().then(a.bind(a,6033))},6033:(e,t,a)=>{"use strict";a.d(t,{ReportEditor:()=>i});var s=a(5155),l=a(2115);function i(e){var t;let{bookingId:a,defaultType:i}=e,[n,r]=(0,l.useState)(!0),[o,d]=(0,l.useState)(!1),[c,h]=(0,l.useState)(!1),[p,m]=(0,l.useState)(!1),[u,x]=(0,l.useState)(null),[b,w]=(0,l.useState)(null),y=(0,l.useMemo)(()=>b?"".concat(window.location.origin,"/report/").concat(b.publicToken):"",[b]);(0,l.useEffect)(()=>{(async()=>{r(!0),x(null);try{let e=await fetch("/api/reports/create-or-get",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({bookingId:a,type:i})});if(!e.ok)throw Error(await e.text());let t=await e.json();w(t)}catch(e){x((null==e?void 0:e.message)||"Failed to load report")}finally{r(!1)}})()},[a,i]);let g=(e,t)=>{b&&w({...b,dataJson:{...b.dataJson,[e]:t}})},f=e=>{if(!b)return;let t=[...b.dataJson.attachments||[],e];w({...b,dataJson:{...b.dataJson,attachments:t}})},v=e=>{if(!b)return;let t=[...b.dataJson.attachments||[]];t.splice(e,1),w({...b,dataJson:{...b.dataJson,attachments:t}})},N=async e=>{if(b&&e&&0!==e.length){m(!0),x(null);try{for(let t of Array.from(e)){let e=await fetch("/api/uploads/presign",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({reportId:b.id,fileName:t.name,contentType:t.type,sizeBytes:t.size})});if(!e.ok)throw Error(await e.text());let a=await e.json();if(!(await fetch(a.uploadUrl,{method:"PUT",headers:{"content-type":t.type},body:t})).ok)throw Error("Upload failed");f({url:a.publicUrl,label:t.name,contentType:a.contentType})}await j()}catch(e){x((null==e?void 0:e.message)||"Failed to upload photo")}finally{m(!1)}}},j=async e=>{if(b){d(!0),x(null);try{let t=await fetch("/api/reports/update",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({id:b.id,status:e,dataJson:b.dataJson})});if(!t.ok)throw Error(await t.text());let a=await t.json();w(a)}catch(e){x((null==e?void 0:e.message)||"Failed to save report")}finally{d(!1)}}},k=async()=>{if(b){h(!0),x(null);try{await j("FINAL");let e=await fetch("/api/reports/send-email",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({reportId:b.id})});if(!e.ok)throw Error(await e.text());window.alert("Report email sent.")}catch(e){x((null==e?void 0:e.message)||"Failed to send email")}finally{h(!1)}}};return n?(0,s.jsx)("div",{className:"text-white/70",children:"Loading report…"}):u?(0,s.jsx)("div",{className:"text-red-300",children:u}):b?(0,s.jsxs)("div",{className:"mt-6 space-y-6",children:[(0,s.jsxs)("div",{className:"grid gap-2",children:[(0,s.jsx)("label",{className:"text-sm text-white/70",children:"Photos (JPG/PNG/WebP)"}),(0,s.jsx)("input",{type:"file",accept:"image/jpeg,image/png,image/webp",multiple:!0,disabled:p,onChange:e=>void N(e.target.files)}),p?(0,s.jsx)("div",{className:"text-white/60 text-sm",children:"Uploading…"}):null,(null===(t=b.dataJson.attachments)||void 0===t?void 0:t.length)?(0,s.jsx)("div",{className:"mt-3 grid gap-3",children:b.dataJson.attachments.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("a",{className:"text-brand-yellow hover:underline text-sm",href:e.url,target:"_blank",rel:"noreferrer",children:e.label||e.url}),(0,s.jsx)("button",{type:"button",className:"text-xs px-2 py-1 rounded border border-white/15 hover:bg-white/5",onClick:()=>v(t),children:"Remove"})]},t))}):(0,s.jsx)("div",{className:"text-white/60 text-sm",children:"No photos uploaded yet."})]}),(0,s.jsxs)("div",{className:"grid gap-2",children:[(0,s.jsx)("label",{className:"text-sm text-white/70",children:"Title"}),(0,s.jsx)("input",{className:"w-full px-3 py-2 rounded bg-black/40 border border-white/10",value:b.dataJson.title,onChange:e=>g("title",e.target.value)})]}),(0,s.jsxs)("div",{className:"grid gap-2",children:[(0,s.jsx)("label",{className:"text-sm text-white/70",children:"Summary (customer-facing)"}),(0,s.jsx)("textarea",{className:"w-full min-h-28 px-3 py-2 rounded bg-black/40 border border-white/10",value:b.dataJson.summary,onChange:e=>g("summary",e.target.value)})]}),(0,s.jsxs)("div",{className:"grid gap-2",children:[(0,s.jsx)("label",{className:"text-sm text-white/70",children:"Report content (plain text / markdown later)"}),(0,s.jsx)("textarea",{className:"w-full min-h-72 px-3 py-2 rounded bg-black/40 border border-white/10 font-mono text-sm",value:b.dataJson.contentMarkdown,onChange:e=>g("contentMarkdown",e.target.value)})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,s.jsx)("button",{type:"button",disabled:o,className:"px-4 py-2 rounded bg-white/10 hover:bg-white/15 disabled:opacity-60",onClick:()=>j(),children:o?"Saving…":"Save"}),(0,s.jsx)("button",{type:"button",disabled:c,className:"px-4 py-2 rounded bg-brand-yellow text-black font-semibold disabled:opacity-60",onClick:k,children:c?"Sending…":"Finalize + Email to customer"}),(0,s.jsx)("a",{className:"text-brand-yellow hover:underline text-sm",href:y,target:"_blank",rel:"noreferrer",children:"Preview customer view"}),(0,s.jsxs)("div",{className:"text-xs text-white/50",children:["Status: ",b.status]})]})]}):(0,s.jsx)("div",{className:"text-white/70",children:"Report not available."})}}},e=>{var t=t=>e(e.s=t);e.O(0,[8441,1517,7358],()=>t(678)),_N_E=e.O()}]);